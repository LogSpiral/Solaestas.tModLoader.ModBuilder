<Project>
	<UsingTask TaskName="GeneratePath"
			   AssemblyFile="$(Solaestas-TaskPath)" />
	<UsingTask TaskName="GenerateConfig"
			   AssemblyFile="$(Solaestas-TaskPath)" />
	<UsingTask TaskName="BuildEffect"
			   AssemblyFile="$(Solaestas-TaskPath)" />
	<UsingTask TaskName="BuildMod"
			   AssemblyFile="$(Solaestas-TaskPath)" />
	<UsingTask TaskName="EnableMod"
			   AssemblyFile="$(Solaestas-TaskPath)" />
	<UsingTask TaskName="ReadConfig"
			   AssemblyFile="$(Solaestas-TaskPath)" />

	<Target Name="CheckImport"
			BeforeTargets="InitModBuilder">
		<Error Condition="'$(tMLPath)' == ''"
			   Text="Missing tModLoader.targets. Please check its parent directory"
			   ContinueOnError="false"/>
	</Target>

	<Target Name="InitModBuilder"
			BeforeTargets="ResolveLockFileReferences"
			Condition="$(EnableModBuilder)">
		<!--读取配置文件-->
		<ReadConfig ConfigPath="$(Solaestas-ConfigPath)">
			<Output TaskParameter="ModDirectory"
					PropertyName="ModDirectory" />
			<Output TaskParameter="TmlVersion"
					PropertyName="TmlVersion" />
			<Output TaskParameter="BuildIdentifier"
					PropertyName="BuildIdentifier" />
		</ReadConfig>
		<PropertyGroup>
			<ModOutput>$(ModDirectory)$(AssemblyName).tmod</ModOutput>
		</PropertyGroup>
		<!--阻止tML程序集复制到输出目录-->
		<ItemGroup>
			<Reference Update="$(tMLLibraryPath)/**/*.dll;$(tMLSteamPath)$(tMLPath)"
					   Private="false" />
			<EffectOutputs Include="@(ModEffect->'$(OutputPath)Assets\%(RelativeDir)%(Filename).xnb')">
				<PathOverride>%(Identity)</PathOverride>
			</EffectOutputs>

			<UpToDateCheckInput Include="@(ModEffect)"
								Set="Effects" />
			<UpToDateCheckOutput Include="@(EffectOutputs)"
								 Set="Effects" />
			<UpToDateCheckBuilt Include="$(ModOutput)" />
		</ItemGroup>
	</Target>

	<Target Name="GenerateConfig"
			BeforeTargets="InitModBuilder"
			Inputs="$(tMLSteamPath)$(tMLPath)"
			Outputs="$(Solaestas-ConfigPath)"
			Condition="$(EnableModBuilder)">
		<!--生成tML版本信息-->
		<GenerateConfig DllPath="$(tMLSteamPath)$(tMLPath)"
						ConfigPath="$(Solaestas-ConfigPath)">
		</GenerateConfig>
	</Target>

	<Target Name="BuildEffect"
			Condition="$(EnableModBuilder)"
			AfterTargets="Compile"
			Inputs="@(ModEffect)"
			Outputs="@(EffectOutputs)">
		<BuildEffect BuilderDirectory="$(Solaestas-ShaderBuilderDirectory)"
					 InputFiles="@(ModEffect)"
					 TargetPlatform="Windows"
					 TargetProfile="HiDef"
					 BuildConfiguration="Debug"
					 IntermediateDirectory="$(IntermediateOutputPath)Assets\"
					 OutputDirectory="$(OutputPath)Assets\">
		</BuildEffect>
	</Target>

	<Target Name="ReadyToBuildMod"
			Condition="$(EnableModBuilder)"
			AfterTargets="Build">
		<ItemGroup>
			<CompileOutputs Include="$(OutputPath)*" />
		</ItemGroup>
	</Target>

	<!--覆盖tML编译-->
	<Target Name="BuildMod"
			Condition="$(EnableModBuilder)"
			AfterTargets="ReadyToBuildMod"
			Inputs="$(Solaestas-ConfigPath);@(ModResource);@(CompileOutputs);@(EffectOutputs);@(ModInfo)"
			Outputs="$(ModOutput)">
		<BuildMod ModSourceDirectory="$(MSBuildProjectDirectory)\"
				  ModName="$(AssemblyName)"
				  OutputDirectory="$(OutputPath)"
				  ResourceFiles="@(ModResource)"
				  ModDirectory="$(ModDirectory)"
				  BuildIdentifier="$(BuildIdentifier)"
				  TmlVersion="$(TmlVersion)" />
	</Target>

	<Target Name="Solaestas-EnableMod"
			Condition="$(EnableModBuilder)"
			AfterTargets="Build">
		<EnableMod BuildingMod="$(AssemblyName)"
				   ModDirectory="$(ModDirectory)"
				   AutoDisable="$(AutoDisableMod)"
				   DebugMod="$(DebugMod)" />
	</Target>

	<Target Name="Solaestas-GeneratePath"
			BeforeTargets="BeforeCompile"
			Condition="$(EnablePathGenerator)">
		<PropertyGroup>
			<PathNamespace Condition="$(PathNamespace) == ''">$(RootNamespace)</PathNamespace>
		</PropertyGroup>
		<GeneratePath AssetFiles="@(ModEffect);@(ModResource)"
					  ClassName="$(PathTypeName)"
					  AssetPrefix="$(PathPrefix)"
					  Namespace="$(PathNamespace)"
					  OutputDirectory="$(BaseIntermediateOutputPath)" />
	</Target>

	<Target Name="Solaestas-CleanAsset"
			BeforeTargets="Clean">
		<RemoveDir Directories="$(IntermediateOutputPath)Assets" />
		<Delete Condition="$(EnablePathGenerator)"
				Files="$(BaseIntermediateOutputPath)ModPath.g.cs" />
		<Delete Files="$(Solaestas-ConfigPath)" />
		<Delete Files="@(EffectOutputs)" />
	</Target>
</Project>