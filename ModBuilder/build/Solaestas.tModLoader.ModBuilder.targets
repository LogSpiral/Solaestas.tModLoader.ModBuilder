<Project>
	<UsingTask TaskName="GeneratePath"
			   AssemblyFile="$(Solaestas-TaskPath)" />
	<UsingTask TaskName="GenerateConfig"
			   AssemblyFile="$(Solaestas-TaskPath)" />
	<UsingTask TaskName="BuildEffect"
			   AssemblyFile="$(Solaestas-TaskPath)" />
	<UsingTask TaskName="BuildMod"
			   AssemblyFile="$(Solaestas-TaskPath)" />
	<UsingTask TaskName="EnableMod"
			   AssemblyFile="$(Solaestas-TaskPath)" />
	<UsingTask TaskName="ReadConfig"
			   AssemblyFile="$(Solaestas-TaskPath)" />

	<Target Name="Solaestas-Test"
			Condition="'$(tMLPath)' == ''"
			BeforeTargets="Build">
		<Error Text="tModLoader.targets not found" />
	</Target>

	<Target Name="InitModBuilder"
			BeforeTargets="ResolveLockFileReferences"
			Condition="$(EnableModBuilder)">
		<!--阻止tML程序集复制到输出目录-->
		<ReadConfig ConfigPath="$(Solaestas-ConfigPath)">
			<Output TaskParameter="ModDirectory"
					PropertyName="ModDirectory" />
			<Output TaskParameter="TmlVersion"
					PropertyName="TmlVersion" />
			<Output TaskParameter="BuildIdentifier"
					PropertyName="BuildIdentifier" />
		</ReadConfig>
		<PropertyGroup>
			<ModOutput>$(ModDirectory)$(AssemblyName).tmod</ModOutput>
		</PropertyGroup>
		<ItemGroup>
			<Reference Update="$(tMLLibraryPath)/**/*.dll;$(tMLSteamPath)$(tMLPath)"
					   Private="false" />
			<EffectOutputs Include="@(ModEffect->'$(OutputPath)Assets\%(RelativeDir)%(Filename).xnb')">
				<PathOverride>%(Identity)</PathOverride>
			</EffectOutputs>

			<UpToDateCheckInput Include="@(ModEffect)" Set="Effects" />
			<UpToDateCheckOutput Include="@(EffectOutputs)" Set="Effects" />
			<UpToDateCheckBuilt Include="$(ModOutput)" />
		</ItemGroup>
	</Target>

	<Target Name="GenerateConfig"
			BeforeTargets="InitModBuilder"
			Inputs="$(tMLSteamPath)$(tMLPath)"
			Outputs="$(Solaestas-ConfigPath)"
			Condition="$(EnableModBuilder)">
		<!--生成tML版本信息-->
		<GenerateConfig DllPath="$(tMLSteamPath)$(tMLPath)"
						ConfigPath="$(Solaestas-ConfigPath)">
		</GenerateConfig>
	</Target>

	<Target Name="BuildEffect"
			Condition="$(EnableModBuilder)"
			AfterTargets="Compile"
			Inputs="@(ModEffect)"
			Outputs="@(EffectOutputs)">
		<BuildEffect BuilderDirectory="$(Solaestas-ShaderBuilderDirectory)"
					 InputFiles="@(ModEffect)"
					 TargetPlatform="Windows"
					 TargetProfile="HiDef"
					 BuildConfiguration="Debug"
					 IntermediateDirectory="$(IntermediateOutputPath)Assets\"
					 OutputDirectory="$(OutputPath)Assets\">
		</BuildEffect>
	</Target>

	<!--覆盖tML编译-->
	<Target Name="BuildMod"
			Condition="$(EnableModBuilder)"
			AfterTargets="Build"
			Inputs="$(Solaestas-ConfigPath);@(ModResource);$(OutputPath)*;@(EffectOutputs);@(ModInfo)"
			Outputs="$(ModOutput)">
		<BuildMod ModSourceDirectory="$(MSBuildProjectDirectory)\"
				  ModName="$(AssemblyName)"
				  OutputDirectory="$(OutputPath)"
				  ResourceFiles="@(ModResource)"
				  ModDirectory="$(ModDirectory)"
				  BuildIdentifier="$(BuildIdentifier)"
				  TmlVersion="$(TmlVersion)" />
	</Target>

	<Target Name="Solaestas-EnableMod"
			Condition="$(EnableModBuilder)"
			AfterTargets="Build">
		<EnableMod BuildingMod="$(AssemblyName)"
				   ModDirectory="$(ModDirectory)"
				   MinimalMod="$(Solaestas-UseMinimalMod)"
				   DebugMod="$(Solaestas-WhitelistMod)" />
	</Target>

	<Target Name="Solaestas-GeneratePath"
			BeforeTargets="BeforeCompile"
			Condition="$(Solaestas-UseAssetPath)">
		<PropertyGroup>
			<Solaestas-AssetNamespace Condition="'$(Solaestas-AssetNamespace)' == ''">$(RootNamespace)</Solaestas-AssetNamespace>
			<Solaestas-AssetClassName Condition="'$(Solaestas-AssetClassName)' == ''">ModAsset</Solaestas-AssetClassName>
		</PropertyGroup>
		<GeneratePath AssetFiles="@(ModEffect);@(ModResource)"
					  ClassName="$(Solaestas-AssetClassName)"
					  AssetPrefix="$(Solaestas-AssetPrefix)"
					  Namespace="$(Solaestas-AssetNamespace)"
					  OutputDirectory="$(BaseIntermediateOutputPath)" />
	</Target>

	<Target Name="Solaestas-CleanAsset"
			BeforeTargets="Clean">
		<RemoveDir Directories="$(IntermediateOutputPath)Assets" />
		<Delete Condition="$(Solaestas-UseAssetPath)"
				Files="$(BaseIntermediateOutputPath)ModPath.g.cs" />
		<Delete Files="$(Solaestas-ConfigPath)" />
		<Delete Files="@(EffectOutputs)" />
	</Target>
</Project>