<Project>
	<UsingTask TaskName="GeneratePath"
			   AssemblyFile="$(Solaestas-TaskPath)" />
	<UsingTask TaskName="GenerateConfig"
			   AssemblyFile="$(Solaestas-TaskPath)" />
	<UsingTask TaskName="BuildEffect"
			   AssemblyFile="$(Solaestas-TaskPath)" />
	<UsingTask TaskName="BuildMod"
			   AssemblyFile="$(Solaestas-TaskPath)" />
	<UsingTask TaskName="EnableMod"
			   AssemblyFile="$(Solaestas-TaskPath)" />
	<UsingTask TaskName="ReadConfig"
			   AssemblyFile="$(Solaestas-TaskPath)" />

	<Target Name="CheckImport"
			BeforeTargets="InitModBuilder">
		<Error Condition="'$(tMLPath)' == ''"
			   Text="Missing tModLoader.targets. Please check its parent directory"
			   ContinueOnError="false" />
	</Target>

	<Target Name="InitModBuilder"
			BeforeTargets="ResolveLockFileReferences"
			Condition="$(EnableModBuilder)">
		<!--读取配置文件-->
		<ReadConfig ConfigPath="$(Solaestas-ConfigPath)">
			<Output TaskParameter="ModDirectory"
					PropertyName="ModDirectory" />
			<Output TaskParameter="TmlVersion"
					PropertyName="TmlVersion" />
			<Output TaskParameter="BuildIdentifier"
					PropertyName="BuildIdentifier" />
		</ReadConfig>
		<PropertyGroup>
			<ModOutput>$(ModDirectory)$(AssemblyName).tmod</ModOutput>
		</PropertyGroup>
		<ItemGroup>
			<!--阻止tML程序集复制到输出目录-->
			<Reference Update="$(tMLLibraryPath)/**/*.dll;$(tMLSteamPath)$(tMLPath)"
					   Private="false" />
			<AdditionalFiles Remove="**/*.fx" />
			<EffectOutputs Include="@(ModEffect->'$(OutputPath)Assets\%(RelativeDir)%(Filename).xnb')"
						   ModPath="$([System.IO.Path]::ChangeExtension(%(ModPath), '.xnb'))" />
			<AdditionalFiles Include="@(EffectOutputs)"
							 ModPath="%(ModPath)"
							 Pack="true" />
			<UpToDateCheckInput Include="@(ModEffect)"
								Set="Effects" />
			<UpToDateCheckOutput Include="@(EffectOutputs)"
								 Set="Effects" />
			<UpToDateCheckBuilt Include="$(ModOutput)" />
		</ItemGroup>
	</Target>

	<Target Name="GenerateConfig"
			BeforeTargets="InitModBuilder"
			Inputs="$(tMLSteamPath)$(tMLPath)"
			Outputs="$(Solaestas-ConfigPath)"
			Condition="$(EnableModBuilder)">
		<!--生成tML版本信息-->
		<GenerateConfig DllPath="$(tMLSteamPath)$(tMLPath)"
						ConfigPath="$(Solaestas-ConfigPath)">
		</GenerateConfig>
	</Target>

	<Target Name="BuildEffect"
			Condition="$(EnableModBuilder)"
			AfterTargets="Compile"
			Inputs="@(ModEffect)"
			Outputs="@(EffectOutputs)">
		<BuildEffect BuilderDirectory="$(Solaestas-ShaderBuilderDirectory)"
					 InputFiles="@(ModEffect)"
					 TargetPlatform="Windows"
					 TargetProfile="HiDef"
					 BuildConfiguration="Debug"
					 IntermediateDirectory="$(BaseIntermediateOutputPath)"
					 OutputDirectory="$(OutputPath)Assets\">
		</BuildEffect>
	</Target>

	<Target Name="ReadyToBuildMod"
			Condition="$(EnableModBuilder)"
			AfterTargets="Build">
		<ItemGroup>
			<CompileOutputs Include="$(OutputPath)*" />
		</ItemGroup>
	</Target>

	<!--覆盖tML编译-->
	<Target Name="BuildMod"
			Condition="$(EnableModBuilder)"
			AfterTargets="ReadyToBuildMod"
			Inputs="$(Solaestas-ConfigPath);@(AdditionalFiles);@(CompileOutputs);@(ModInfo)"
			Outputs="$(ModOutput)">
		<BuildMod ModSourceDirectory="$(MSBuildProjectDirectory)\"
				  ModName="$(AssemblyName)"
				  OutputDirectory="$(OutputPath)"
				  ResourceFiles="@(AdditionalFiles)"
				  ModDirectory="$(ModDirectory)"
				  BuildIdentifier="$(BuildIdentifier)"
				  TmlVersion="$(TmlVersion)" />
	</Target>

	<Target Name="Solaestas-EnableMod"
			Condition="$(EnableModBuilder)"
			AfterTargets="Build">
		<EnableMod BuildingMod="$(AssemblyName)"
				   ModDirectory="$(ModDirectory)"
				   AutoDisable="$(AutoDisableMod)"
				   DebugMod="$(DebugMod)" />
	</Target>

	<Target Name="CleanModBuilder"
			BeforeTargets="Clean">
		<Delete Files="$(Solaestas-ConfigPath)" />
		<Delete Files="@(EffectOutputs)" />
	</Target>
</Project>